<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigyn BehaviorTree Monitor</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #252526;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        h1 {
            font-size: 24px;
            color: #4fc3f7;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
        }
        
        .status-dot.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 0;
            overflow: hidden;
        }
        
        #tree-container {
            background: #1e1e1e;
            overflow: auto;
            position: relative;
        }
        
        #tree-svg {
            width: 100%;
            height: 100%;
        }
        
        aside {
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel {
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            overflow-y: auto;
        }
        
        .panel h2 {
            font-size: 16px;
            color: #4fc3f7;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .node-info {
            flex: 0 0 auto;
            max-height: 200px;
        }
        
        .blackboard-panel {
            flex: 1;
            overflow-y: auto;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }
        
        .info-label {
            color: #858585;
            font-size: 13px;
        }
        
        .info-value {
            color: #d4d4d4;
            font-weight: 500;
            font-size: 13px;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node rect {
            fill: #2d2d30;
            stroke: #3e3e42;
            stroke-width: 2;
            transition: all 0.3s;
        }
        
        .node.idle rect {
            fill: #2d2d30;
            stroke: #858585;
        }
        
        .node.running rect {
            fill: #264f78;
            stroke: #4fc3f7;
            stroke-width: 3;
            animation: pulse 1.5s infinite;
        }
        
        .node.success rect {
            fill: #1e4620;
            stroke: #4caf50;
        }
        
        .node.failure rect {
            fill: #5a1e1e;
            stroke: #f44336;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .node text {
            fill: #d4d4d4;
            font-size: 12px;
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #3e3e42;
            stroke-width: 2;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: #2d2d30;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .stat-label {
            font-size: 11px;
            color: #858585;
            text-transform: uppercase;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ¤– Sigyn BehaviorTree Monitor</h1>
        <div class="connection-status">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Disconnected</span>
            <span id="update-counter" style="margin-left: 20px; color: #858585;">Updates: 0</span>
        </div>
    </header>
    
    <main>
        <div id="tree-container">
            <svg id="tree-svg"></svg>
        </div>
        
        <aside>
            <div class="panel node-info">
                <h2>Node Info</h2>
                <div id="node-details">
                    <p style="color: #858585; font-style: italic;">Select a node to view details</p>
                </div>
            </div>
            
            <div class="panel stats">
                <div class="stat-box">
                    <div class="stat-value" id="active-nodes">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-nodes">0</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
            
            <div class="panel blackboard-panel">
                <h2>Blackboard</h2>
                <div id="blackboard-content">
                    <p style="color: #858585; font-style: italic;">No data yet...</p>
                </div>
            </div>
        </aside>
    </main>
    
    <script>
        // Socket.IO connection with debugging
        const socket = io({
            transports: ['polling', 'websocket']
        });
        
        let treeData = {
            nodes: {},
            blackboard: {}
        };
        
        let updateTimer = null;
        let updateCount = 0;
        
        // Connection status
        socket.on('connect', () => {
            console.log('Socket.IO connected');
            document.getElementById('status-dot').classList.add('connected');
            document.getElementById('status-text').textContent = 'Connected';
            socket.emit('request_state');
        });
        
        socket.on('disconnect', () => {
            console.log('Socket.IO disconnected');
            document.getElementById('status-dot').classList.remove('connected');
            document.getElementById('status-text').textContent = 'Disconnected';
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });
        
        // Node updates
        socket.on('node_update', (data) => {
            console.log('Received node_update:', data);
            if (!treeData.nodes) treeData.nodes = {};
            
            treeData.nodes[data.node] = {
                status: data.status.toLowerCase(),
                timestamp: data.timestamp
            };
            updateCount++;
            document.getElementById('update-counter').textContent = `Updates: ${updateCount}`;
            
            // Immediate update (no debouncing)
            updateTreeVisualization();
            updateStats();
        });
        
        // Blackboard updates
        socket.on('blackboard_update', (data) => {
            Object.assign(treeData.blackboard, data);
            updateBlackboard();
        });
        
        // Full state update
        socket.on('full_state', (data) => {
            treeData = data;
            updateTreeVisualization();
            updateBlackboard();
            updateStats();
        });
        
        // Tree visualization with efficient updates
        let isInitialized = false;
        
        function updateTreeVisualization() {
            const nodes = Object.entries(treeData.nodes);
            if (nodes.length === 0) return;
            
            const svg = d3.select('#tree-svg');
            const width = document.getElementById('tree-container').clientWidth;
            const height = Math.max(600, nodes.length * 50);
            
            svg.attr('width', width).attr('height', height);
            
            // Initialize on first run
            if (!isInitialized || svg.select('g').empty()) {
                svg.selectAll('*').remove();
                svg.append('g').attr('transform', 'translate(50, 50)');
                isInitialized = true;
            }
            
            const g = svg.select('g');
            
            // Bind data with key function
            const nodeGroups = g.selectAll('.node')
                .data(nodes, d => d[0]); // Use node name as key
            
            // Enter: create new nodes
            const enter = nodeGroups.enter()
                .append('g')
                .attr('class', d => `node ${d[1].status}`)
                .attr('transform', (d, i) => `translate(100, ${i * 60})`)
                .on('click', d => showNodeDetails(d[0], d[1]));
            
            enter.append('rect')
                .attr('width', width - 250)
                .attr('height', 40)
                .attr('rx', 5);
            
            enter.append('text')
                .attr('class', 'node-name')
                .attr('x', 10)
                .attr('y', 25)
                .text(d => d[0]);
            
            enter.append('text')
                .attr('class', 'node-status')
                .attr('x', width - 320)
                .attr('y', 25)
                .attr('text-anchor', 'end')
                .style('font-size', '10px');
            
            // Update: merge enter + existing, update classes and text
            const merged = enter.merge(nodeGroups)
                .attr('class', d => `node ${d[1].status}`)
                .attr('transform', (d, i) => `translate(100, ${i * 60})`);
            
            merged.select('.node-status')
                .style('fill', d => getStatusColor(d[1].status))
                .text(d => d[1].status.toUpperCase());
            
            // Exit: remove old nodes
            nodeGroups.exit().remove();
        }
        
        function getStatusColor(status) {
            const colors = {
                'idle': '#858585',
                'running': '#4fc3f7',
                'success': '#4caf50',
                'failure': '#f44336'
            };
            return colors[status] || '#858585';
        }
        
        function showNodeDetails(name, data) {
            const details = document.getElementById('node-details');
            details.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Name</span>
                    <span class="info-value">${name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="info-value" style="color: ${getStatusColor(data.status)}">${data.status.toUpperCase()}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Update</span>
                    <span class="info-value">${data.timestamp || 'N/A'}</span>
                </div>
            `;
        }
        
        function updateBlackboard() {
            const content = document.getElementById('blackboard-content');
            const entries = Object.entries(treeData.blackboard);
            
            if (entries.length === 0) {
                content.innerHTML = '<p style="color: #858585; font-style: italic;">No data yet...</p>';
                return;
            }
            
            content.innerHTML = entries.map(([key, value]) => `
                <div class="info-row">
                    <span class="info-label">${key}</span>
                    <span class="info-value">${JSON.stringify(value)}</span>
                </div>
            `).join('');
        }
        
        function updateStats() {
            const nodes = Object.values(treeData.nodes);
            const activeNodes = nodes.filter(n => n.status === 'running').length;
            
            document.getElementById('active-nodes').textContent = activeNodes;
            document.getElementById('total-nodes').textContent = nodes.length;
        }
        
        // Initial render
        updateTreeVisualization();
        
        // Handle window resize
        window.addEventListener('resize', () => {
            updateTreeVisualization();
        });
    </script>
</body>
</html>
