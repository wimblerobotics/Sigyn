<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <Sequence>
            <Action ID="SaySomething" message="Starting Step3: VisuallyAcquireCan" />
            <Action ID="SetBlackboard" output_key="objectOfInterest" value="CokeZeroCan" />
            <Action ID="SetBlackboard" output_key="needToVisuallyAcquire" value="true" />
            <Action ID="SetBlackboard" output_key="within_distance" value="0.49" />
            <!-- <SubTree ID="VisuallyAcquireCan" __shared_blackboard="true"
                objectOfInterest="{objectOfInterest}"
                within_distance="{within_distance}" />
            <Action ID="SaySomething" message="Step3 complete" /> -->
            <SubTree ID="SearchForCanWithOAKD" __shared_blackboard="true"
                objectOfInterest="{objectOfInterest}" />
            <Action ID="SaySomething" message="SearchForCanWithOAKD" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="SearchForCanWithOAKD">
        <Sequence>
            <Action ID="WaitForDetection" />
            <ReactiveFallback name="FindCanVisually">
                <Condition ID="CanDetectedByOAKD" objectOfInterest="{objectOfInterest}" />
                <ForceFailure>
                    <Decorator ID="ReactiveRepeatUntilSuccessOrCount" num_cycles="72">
                        <Sequence>
                            <Action ID="RotateRobot" degrees="5" />
                            <Action ID="WaitForNewOAKDFrame" />
                            <AlwaysFailure />
                        </Sequence>
                    </Decorator>
                </ForceFailure>
            </ReactiveFallback>
        </Sequence>
    </BehaviorTree>
    <BehaviorTree ID="ApproachCanWithOAKD">
        <ReactiveSequence name="ApproachLoop">
            <Action ID="OAKDDetectCan"
                objectOfInterest="{objectOfInterest}"
                can_detected="{can_detected}"
                can_location="{can_location}" />
            <RetryUntilSuccessful num_attempts="-1">
                <ReactiveFallback name="GetWithinReachOrMove">
                    <Condition ID="CanWithinReach"
                        can_detected="{can_detected}"
                        can_location="{can_location}"
                        within_distance="{within_distance}" />
                    <ForceFailure>
                        <ReactiveSequence>
                            <Action ID="MoveTowardsCan"
                                can_detected="{can_detected}"
                                can_location="{can_location}"
                                target_distance_from_object="{within_distance}" />
                            <Action ID="WaitForNewOAKDFrame" />
                            <Action ID="OAKDDetectCan"
                                objectOfInterest="{objectOfInterest}"
                                can_detected="{can_detected}"
                                can_location="{can_location}" />
                        </ReactiveSequence>
                    </ForceFailure>
                </ReactiveFallback>
            </RetryUntilSuccessful>
        </ReactiveSequence>
    </BehaviorTree>

    <BehaviorTree ID="VisuallyAcquireCan">
        <ReactiveFallback>
            <Condition ID="CheckBoolFlag" expected="false" flag="{needToVisuallyAcquire}" />
            <Sequence>
                <SubTree ID="SearchForCanWithOAKD" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="ApproachCanWithOAKD" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}"
                    within_distance="{within_distance}" />
                <SetBlackboard output_key="needToVisuallyAcquire" value="false" />
            </Sequence>
        </ReactiveFallback>
    </BehaviorTree>
</root>