<?xml version="1.0"?>
<root main_tree_to_execute="MainTree">
    <!-- ////////// -->
    <BehaviorTree ID="ApproachCanWithOAKD">
        <ReactiveSequence name="ApproachLoop">
            <Action ID="OAKDDetectCan"
                objectOfInterest="{objectOfInterest}"
                can_detected="{can_detected}"
                can_location="{can_location}" />
            <RetryUntilSuccessful num_attempts="-1">
                <ReactiveFallback name="GetWithinReachOrMove">
                    <Condition ID="CanWithinReach"
                        can_detected="{can_detected}"
                        can_location="{can_location}"
                        within_distance="{within_distance}" />
                    <ForceFailure>
                        <ReactiveSequence>
                            <Action ID="MoveTowardsCan"
                                can_detected="{can_detected}"
                                can_location="{can_location}"
                                target_distance_from_object="{within_distance}" />
                            <Action ID="WaitForNewOAKDFrame" />
                            <Action ID="OAKDDetectCan"
                                objectOfInterest="{objectOfInterest}"
                                can_detected="{can_detected}"
                                can_location="{can_location}" />
                        </ReactiveSequence>
                    </ForceFailure>
                </ReactiveFallback>
            </RetryUntilSuccessful>
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="BatteryIsCharged">
        <ReactiveFallback name="ChargingNotNeeded">
            <Condition ID="BatteryAboveChargingVoltage" />
            <Action ID="ChargeBattery" />
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="CenterCanInPiCamera">
        <Decorator ID="ReactiveRepeatUntilSuccessOrCount" num_cycles="5">
            <Sequence>
                <Condition ID="WaitForNewPiFrameProcessed" />
                <ReactiveFallback name="CheckOrAdjust">
                    <Condition ID="CanCenteredInPiCamera" objectOfInterest="{objectOfInterest}" />
                    <Action ID="AdjustExtenderToCenterCan" objectOfInterest="{objectOfInterest}" />
                </ReactiveFallback>
            </Sequence>
        </Decorator>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="EnsureBatteryIsNotCritical">
        <ReactiveFallback name="SystemShutdownNotNeeded">
            <Condition ID="BatteryAboveCriticalVoltage" />
            <Action ID="ShutdownSystem" />
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="ExecuteGrasp">
        <Sequence>
            <Action ID="OpenGripper" />
            <Sequence>
                <Condition ID="WaitForNewPiFrameProcessed" />
                <Action ID="ExtendTowardsCan" objectOfInterest="{objectOfInterest}" />
            </Sequence>
            <Action ID="CloseGripperAroundCan" canDiameter="0.06" />
            <Action ID="StepElevatorUp" stepMeters="0.1" />
            <!-- <Action ID="RotateRobot" degrees="20" /> -->
            <ReactiveFallback name="VerifyGrasp">
                <Sequence>
                    <Condition ID="WaitForNewPiFrameProcessed" />
                    <Condition ID="CanIsGrasped" objectOfInterest="{objectOfInterest}" />
                </Sequence>
                <Action ID="ReportGraspFailure" />
            </ReactiveFallback>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="GraspCan">
        <ReactiveFallback>
            <Condition ID="CheckBoolFlag" expected="false" flag="{needToGrasp}" />
            <Sequence>
                <SubTree ID="RaiseElevatorToCanHeight" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="CenterCanInPiCamera" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="ExecuteGrasp" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="RetractAfterGrasp" />
                <SetBlackboard output_key="needToGrasp" value="false" />
            </Sequence>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="MainTree">
        <Sequence>
            <Action ID="SaveRobotPose" saveTo="{startingPose}" />
            <SubTree ID="SetupCanChallenge" __shared_blackboard="true"
                objectOfInterest="CokeZeroCan" />
            <ReactiveSequence name="FetchCan">
                <!-- <SubTree ID="ReactiveRobotSafety" /> -->
                <SubTree ID="NavigateToCanLocation" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="VisuallyAcquireCan" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <!-- <SubTree ID="GraspCan" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" /> -->
            </ReactiveSequence>
            <!-- <Action ID="BackAwayFromTable" distance="0.3" speed="0.1" />
            <SubTree ID="ReturnToStart" __shared_blackboard="true"
                objectOfInterest="{objectOfInterest}" /> -->
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="NavigateToCanLocation">
        <ReactiveFallback>
            <Condition ID="CheckBoolFlag" expected="false" flag="{needToNavigate}" />
            <Sequence>
                <Action ID="ComputePathToCanLocation" goal="{goal}" location="{expectedCanLocation}"
                    path="{path}" />
                <Action ID="NavigateToPoseAction" error_code_id="{nav_error_code}" goal="{goal}" />
                <SetBlackboard output_key="needToNavigate" value="false" />
            </Sequence>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RaiseElevatorToCanHeight">
        <Sequence>
            <RetryUntilSuccessful num_attempts="45">
                <ReactiveFallback>
                    <Condition ID="ElevatorAtHeight" targetHeightPixels="342.0"
                        z_tolerance_pixels="10.0" />
                    <Sequence>
                        <Action ID="StepElevatorUp" stepMeters="0.02" />
                        <ForceFailure>
                            <Condition ID="WaitForNewPiFrameProcessed" />
                        </ForceFailure>
                    </Sequence>
                </ReactiveFallback>
            </RetryUntilSuccessful>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="ReactiveRobotSafety">
        <ReactiveSequence>
            <SubTree ID="RobotHasNotFallenOver" />
            <SubTree ID="RobotIsNotAboutToFallOver" />
            <SubTree ID="RobotIsNotEStopped" />
            <SubTree ID="EnsureBatteryIsNotCritical" />
            <SubTree ID="BatteryIsCharged" />
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RetractAfterGrasp">
        <Sequence>
            <Action ID="RetractExtender" />
            <Action ID="LowerElevatorSafely" />
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="ReturnToStart">
        <Action ID="NavigateToPoseAction" error_code_id="{nav_error_code}" goal="{startingPose}" />
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotHasNotFallenOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedCritically" />
            </Inverter>
            <Action ID="ShutdownSystem" />
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotAboutToFallOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedWarning" />
            </Inverter>
            <Action ID="SoftwareEStop" reason="Robot is about to fall over" />
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotEStopped">
        <Inverter>
            <Condition ID="RobotIsEstopped" />
        </Inverter>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SearchForCanWithOAKD">
        <Sequence>
            <Action ID="WaitForDetection" />
            <ReactiveFallback name="FindCanVisually">
                <Condition ID="CanDetectedByOAKD" objectOfInterest="{objectOfInterest}" />
                <ForceFailure>
                    <Decorator ID="ReactiveRepeatUntilSuccessOrCount" num_cycles="12">
                        <Sequence>
                            <Action ID="RotateRobot" degrees="30.0" />
                            <Action ID="WaitForNewOAKDFrame" />
                            <AlwaysFailure />
                        </Sequence>
                    </Decorator>
                </ForceFailure>
            </ReactiveFallback>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SetupCanChallenge">
        <Sequence>
            <SetBlackboard output_key="objectOfInterest" value="CokeZeroCan" />
            <SetBlackboard output_key="needToNavigate" value="true" />
            <SetBlackboard output_key="needToVisuallyAcquire" value="true" />
            <SetBlackboard output_key="needToGrasp" value="true" />
            <SetBlackboard output_key="within_distance" value="0.45" />
            <Action ID="LoadCanLocation" canName="{objectOfInterest}"
                location="{expectedCanLocation}" />
            <Action ID="RetractGripper" />
            <Action ID="LowerElevator" />
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="VisuallyAcquireCan">
        <ReactiveFallback>
            <Condition ID="CheckBoolFlag" expected="false" flag="{needToVisuallyAcquire}" />
            <Sequence>
                <SubTree ID="SearchForCanWithOAKD" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}" />
                <SubTree ID="ApproachCanWithOAKD" __shared_blackboard="true"
                    objectOfInterest="{objectOfInterest}"
                    within_distance="{within_distance}" />
                <SetBlackboard output_key="needToVisuallyAcquire" value="false" />
            </Sequence>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Action ID="AdjustExtenderToCenterCan">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Action>
        <SubTree ID="ApproachCanWithOAKD">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
            <input_port default="{within_distance}" name="within_distance" />
        </SubTree>
        <Action ID="BackAwayFromTable">
            <input_port default="0.3" name="distance">Distance to back away in meters</input_port>
            <input_port default="0.1" name="speed">Backing speed (m/s)</input_port>
        </Action>
        <Condition ID="BatteryAboveChargingVoltage" />
        <Condition ID="BatteryAboveCriticalVoltage" />
        <SubTree ID="BatteryIsCharged" />
        <Condition ID="CanCenteredInPiCamera">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanDetectedByOAKD">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanDetectedByPiCamera">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanIsGrasped">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanWithinReach">
            <input_port name="can_detected">Whether can was detected</input_port>
            <input_port name="can_location">Can location PointStamped in base_link</input_port>
            <input_port default="0.45" name="within_distance">Distance threshold (m) to consider the
                can within reach</input_port>
        </Condition>
        <SubTree ID="CenterCanInPiCamera">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Action ID="ChargeBattery" />
        <Condition ID="CheckBoolFlag">
            <input_port name="expected">Expected value</input_port>
            <input_port name="flag">Boolean flag to check</input_port>
        </Condition>
        <Action ID="CloseGripperAroundCan">
            <input_port default="0.066" name="canDiameter">Diameter of can in meters</input_port>
        </Action>
        <Action ID="ComputeApproachGoalToCan">
            <output_port name="goal">Approach goal pose (map frame)</output_port>
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Action>
        <Action ID="ComputeElevatorHeight">
            <input_port name="canLocation">Can location Point with x,y,z</input_port>
            <output_port name="targetHeight">Computed elevator target height</output_port>
        </Action>
        <Action ID="ComputePathToCanLocation">
            <output_port name="goal">Goal pose near can</output_port>
            <input_port name="location">Expected can location</input_port>
            <output_port name="path">Computed path</output_port>
        </Action>
        <Action ID="ComputePathToPose">
            <output_port name="error_code_id">Error code</output_port>
            <input_port name="goal">Goal pose</input_port>
            <output_port name="path">Computed path</output_port>
            <input_port name="planner_id">Planner to use</input_port>
        </Action>
        <Condition ID="ElevatorAtHeight">
            <input_port name="targetHeightPixels">Target Y pixel height (2D logic)</input_port>
            <input_port name="z_tolerance_pixels">Tolerance in pixels</input_port>
        </Condition>
        <SubTree ID="EnsureBatteryIsNotCritical" />
        <SubTree ID="ExecuteGrasp">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Action ID="ExtendTowardsCan">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Action>
        <Action ID="FollowPath">
            <input_port name="controller_id">Controller to use</input_port>
            <output_port name="error_code_id">Error code</output_port>
            <input_port name="path">Path to follow</input_port>
        </Action>
        <SubTree ID="GraspCan">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Action ID="LoadCanLocation">
            <input_port name="canName">Name of can to find</input_port>
            <output_port name="location">Expected location from database</output_port>
        </Action>
        <Action ID="LowerElevator" />
        <Action ID="LowerElevatorSafely" />
        <Action ID="LowerElevatorToTable">
            <input_port name="targetHeight">Target height for approach</input_port>
        </Action>
        <Action ID="MoveElevatorToHeight">
            <input_port name="targetHeight">Target height in meters</input_port>
        </Action>
        <Action ID="MoveTowardsCan">
            <input_port name="can_detected">Whether can was detected</input_port>
            <input_port name="can_location">Can location PointStamped in base_link</input_port>
            <input_port default="0.01" name="target_distance_from_object">Desired distance to stop from object (meters)</input_port>
            <input_port default="0.01" name="distance_tolerance">Distance tolerance around target distance (meters)</input_port>
            <input_port default="0.0523598776" name="angular_tolerance">Angular tolerance (radians)</input_port>
            <input_port default="0.35" name="angular_velocity">Angular velocity (rad/sec)</input_port>
            <input_port default="0.15" name="linear_velocity">Linear velocity (m/sec)</input_port>
            <input_port default="30" name="commands_per_sec">Max cmd_vel commands per second</input_port>
        </Action>
        <Action ID="OAKDDetectCan">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
            <output_port name="can_detected">Whether can was detected</output_port>
            <output_port name="can_location">Can location PointStamped in base_link</output_port>
        </Action>
        <SubTree ID="NavigateToCanLocation">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Action ID="NavigateToPoseAction">
            <inout_port name="error_code_id" />
            <inout_port name="goal" />
        </Action>
        <Action ID="OpenGripper" />
        <SubTree ID="RaiseElevatorToCanHeight">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Decorator ID="ReactiveRepeatUntilSuccessOrCount">
            <input_port name="num_cycles">Number of cycles to repeat</input_port>
        </Decorator>
        <SubTree ID="ReactiveRobotSafety" />
        <Action ID="ReportGraspFailure" />
        <SubTree ID="RetractAfterGrasp" />
        <Action ID="RetractExtender" />
        <Action ID="RetractGripper" />
        <SubTree ID="ReturnToStart">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <SubTree ID="RobotHasNotFallenOver" />
        <Condition ID="RobotIsEstopped" />
        <SubTree ID="RobotIsNotAboutToFallOver" />
        <SubTree ID="RobotIsNotEStopped" />
        <Condition ID="RobotTiltedCritically" />
        <Condition ID="RobotTiltedWarning" />
        <Action ID="RotateRobot">
            <input_port default="0" name="degrees">Degrees to rotate</input_port>
        </Action>
        <Action ID="SaveRobotPose">
            <output_port name="saveTo">Where to save current pose</output_port>
        </Action>
        <SubTree ID="SearchForCanWithOAKD">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <SubTree ID="SetupCanChallenge">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="CokeZeroCan" name="objectOfInterest" />
        </SubTree>
        <Action ID="ShutdownSystem" />
        <Action ID="SoftwareEStop">
            <input_port default="Emergency stop" name="reason" />
        </Action>
        <Action ID="StepElevatorUp">
            <input_port default="0.01" name="stepMeters">Step size in meters</input_port>
        </Action>
        <SubTree ID="VisuallyAcquireCan">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <Action ID="WaitForDetection" />
        <Action ID="WaitForNewOAKDFrame" />
        <Condition ID="WaitForNewPiFrameProcessed" />
    </TreeNodesModel>
    <!-- ////////// -->
</root>