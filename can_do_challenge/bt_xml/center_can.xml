<?xml version="1.0"?>
<root main_tree_to_execute="foo">
    <BehaviorTree ID="foo">
        <Sequence>
            <Action ID="SaveRobotPose" saveTo="{startingPose}" />
            <SubTree ID="SetupCanChallenge" __shared_blackboard="true"
                objectOfInterest="CokeZeroCan" />
            <!-- <Action ID="MoveElevatorToHeight" targetHeight="0.5" /> -->
            <Action ID="WaitForDetection" />
            <Condition ID="CanDetectedByOAKD" objectOfInterest="{objectOfInterest}" />
            <SubTree ID="RaiseElevatorToCanHeight" __shared_blackboard="true"
                objectOfInterest="{objectOfInterest}" />
            <!-- <SubTree ID="ExecuteGrasp" __shared_blackboard="true"
                objectOfInterest="{objectOfInterest}" /> -->
        </Sequence>
    </BehaviorTree>
    <BehaviorTree ID="GraspCan">
        <Sequence>
            <!-- Initialize blackboard -->
            <Action ID="SaveRobotPose" saveTo="{startingPose}" />
            <SubTree ID="SetupCanChallenge" __shared_blackboard="true"
                objectOfInterest="CokeZeroCan" />

            <!-- Main grasp logic -->
            <ReactiveFallback>
                <Condition ID="CheckBoolFlag" expected="false" flag="{needToGrasp}" />
                <Sequence>
                    <SubTree ID="RaiseElevatorToCanHeight" __shared_blackboard="true"
                        objectOfInterest="{objectOfInterest}" />
                    <SubTree ID="CenterCanInPiCamera" __shared_blackboard="true"
                        objectOfInterest="{objectOfInterest}" />
                    <!--<SubTree
                    ID="ExecuteGrasp" __shared_blackboard="true"
                        objectOfInterest="{objectOfInterest}" /> -->
                    <SubTree ID="RetractAfterGrasp" />
                    <SetBlackboard output_key="needToGrasp" value="false" />
                </Sequence>
            </ReactiveFallback>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="CenterCanInPiCamera">
        <Decorator ID="ReactiveRepeatUntilSuccessOrCount" num_cycles="5">
            <Sequence>
                <Condition ID="WaitForNewPiFrameProcessed" />
                <ReactiveFallback name="CheckOrAdjust">
                    <Condition ID="CanCenteredInPiCamera" objectOfInterest="{objectOfInterest}" />
                    <Action ID="AdjustExtenderToCenterCan" objectOfInterest="{objectOfInterest}"
                        max_center_error_deg="2.0" />
                </ReactiveFallback>
            </Sequence>
        </Decorator>
    </BehaviorTree>

    <BehaviorTree ID="ExecuteGrasp">
        <Sequence>
            <Action ID="OpenGripper" />
            <Sequence>
                <Condition ID="WaitForNewPiFrameProcessed" />
                <Action ID="ExtendTowardsCan" objectOfInterest="{objectOfInterest}" />
            </Sequence>
            <Action ID="CloseGripperAroundCan" canDiameter="0.06" />
            <Action ID="StepElevatorUp" stepMeters="0.1" />
            <!-- <Action ID="RotateRobot" degrees="20" /> -->
            <ReactiveFallback name="VerifyGrasp">
                <Sequence>
                    <Condition ID="WaitForNewPiFrameProcessed" />
                    <Condition ID="CanIsGrasped" objectOfInterest="{objectOfInterest}" />
                </Sequence>
                <Action ID="ReportGraspFailure" />
            </ReactiveFallback>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="RaiseElevatorToCanHeight">
        <Sequence>
            <!-- Wait for vision system to be ready -->
            <Condition ID="WaitForNewPiFrameProcessed" />

            <!-- One-shot elevator move from OAK-D object Z height -->
            <Action ID="MoveElevatorToObjectHeight" objectOfInterest="{objectOfInterest}" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="SetupCanChallenge">
        <Sequence>
            <SetBlackboard output_key="objectOfInterest" value="CokeZeroCan" />
            <SetBlackboard output_key="needToNavigate" value="true" />
            <SetBlackboard output_key="needToVisuallyAcquire" value="true" />
            <SetBlackboard output_key="needToGrasp" value="true" />
            <SetBlackboard output_key="within_distance" value="0.49" />
            <Action ID="RetractGripper" />
            <Action ID="LowerElevator" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="RetractAfterGrasp">
        <Sequence>
            <Action ID="RetractExtender" />
            <Action ID="LowerElevatorSafely" />
        </Sequence>
    </BehaviorTree>

    <TreeNodesModel>
        <Action ID="AdjustExtenderToCenterCan">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
            <input_port default="2.0" name="max_center_error_deg">Maximum allowed horizontal centering error in degrees</input_port>
        </Action>
        <Condition ID="CanCenteredInPiCamera">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanDetectedByOAKD">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CanIsGrasped">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Condition>
        <Condition ID="CheckBoolFlag">
            <input_port name="expected">Expected value</input_port>
            <input_port name="flag">Boolean flag to check</input_port>
        </Condition>
        <Action ID="CloseGripperAroundCan">
            <input_port default="0.066" name="canDiameter">Diameter of can in meters</input_port>
        </Action>
        <Action ID="ExtendTowardsCan">
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </Action>
        <Action ID="LowerElevator" />
        <Action ID="LowerElevatorSafely" />
        <Action ID="MoveElevatorToHeight">
            <input_port name="targetHeight">Target height in meters</input_port>
        </Action>
        <Action ID="MoveElevatorToObjectHeight">
            <input_port default="{objectOfInterest}" name="objectOfInterest">Object class/name to target</input_port>
            <input_port default="0.0" name="heightOffset">Optional height offset in meters</input_port>
        </Action>
        <Action ID="OpenGripper" />
        <Action ID="ReportGraspFailure" />
        <Action ID="RetractExtender" />
        <Action ID="RetractGripper" />
        <Action ID="SaveRobotPose">
            <output_port name="saveTo">Where to save current pose</output_port>
        </Action>
        <Action ID="StepElevatorUp">
            <input_port default="0.01" name="stepMeters">Step size in meters</input_port>
        </Action>
        <Action ID="WaitForDetection" />
        <Condition ID="WaitForNewPiFrameProcessed" />

        <SubTree ID="CenterCanInPiCamera">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <SubTree ID="ExecuteGrasp">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <SubTree ID="RaiseElevatorToCanHeight">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="{objectOfInterest}" name="objectOfInterest" />
        </SubTree>
        <SubTree ID="RetractAfterGrasp" />
        <SubTree ID="SetupCanChallenge">
            <input_port default="true" name="__shared_blackboard" />
            <input_port default="CokeZeroCan" name="objectOfInterest" />
        </SubTree>
    </TreeNodesModel>
</root>