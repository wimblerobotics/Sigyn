<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BatteryIsCharged">
        <ReactiveFallback name="ChargingNotNeeded">
            <Condition ID="BatteryAboveChargingVoltage"/>
            <Action ID="ChargeBattery"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <Action ID="SetRobotLocation" currentLocation=""/>
            <SubTree ID="SetupFetchAnObject" __shared_blackboard="true" objectOfInterest="&quot;codeZeroCan&quot;"/>
            <ReactiveSequence name="FindFetchReturnObject">
                <SubTree ID="ReactiveRobotSafety"/>
                <SubTree ID="FindObjectOfInterest" __shared_blackboard="true" objectOfInterest="{objectOfInterest}" shouldHomeGripper="true"/>
                <SubTree ID="FetchObjectOfInterest" __shared_blackboard="true" objectOfInterest="{objectOfInterest}"/>
                <SubTree ID="NavigatoToLocation" __shared_blackboard="true" location="{objectOfInterest}"/>
            </ReactiveSequence>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="EnsureBatteryIsNoCritical">
        <ReactiveFallback name="SystemShutdownNotNeeded">
            <Condition ID="BatteryAboveCriticalVoltage"/>
            <Action ID="ShutdownSystem"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="FetchObjectOfInterest">
        <ReactiveSequence>
            <ReactiveFallback name="GetElevatorToObjectHeight">
                <Condition ID="ElevatorIsAtObjectHeight" objectOfInterest="{objectOfInterest}"/>
                <ForceFailure>
                    <ReactiveSequence>
                        <SubTree ID="RotateUntilWideAngleSeesObjectOfInterest" __shared_blackboard="true" objectOfInterest="{objectOfInterest}"/>
                        <ReactiveFallback name="RaiseElevatorUntilAtObjectOfInterestHeight">
                            <Condition ID="ElevatorIsAtMaximumHeight"/>
                            <ForceFailure>
                                <Decorator ID="ReactiveRepeat" num_cycles="400">
                                    <Action ID="MoveElevatorRelative" distance_mm="10"/>
                                </Decorator>
                            </ForceFailure>
                        </ReactiveFallback>
                    </ReactiveSequence>
                </ForceFailure>
            </ReactiveFallback>
            <ReactiveFallback name="CenterObjectInGripper">
                <Condition ID="ObjectOfInterestIsCenteredInGripper" objectOfInterest="{objectOfInterest}"/>
                <ForceFailure>
                    <Decorator ID="ReactiveRepeat" num_cycles="25">
                        <Action ID="RotateToCenterObjectOfInterestInGripper" objectOfInterest="{objectOfInterest}"/>
                    </Decorator>
                </ForceFailure>
            </ReactiveFallback>
            <ReactiveFallback name="GraspObjectOfInterest">
                <Condition ID="ObjectOfInterestIsGrasped" objectOfInterest="{objectOfInterest}"/>
            </ReactiveFallback>
            <ReactiveFallback name="RetractExtender">
                <Condition ID="ExtenderIsRetracted"/>
            </ReactiveFallback>
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="FindObjectOfInterest">
        <ReactiveFallback>
            <Condition ID="IsAtPose" pose="{objectOfInterest}"/>
            <ReactiveSequence>
                <SubTree ID="HomeGripperIfNeeded" __shared_blackboard="true" shouldHomeGripper="true"/>
                <ForceFailure>
                    <Action ID="NavigateToPose" pose="{objectOfInterest}"/>
                </ForceFailure>
            </ReactiveSequence>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="GoToGoal">
        <Sequence name="Move to a goal">
            <Action ID="ComputePathToPose" error_code_id="" goal="{goal}" path="{path}" planner_id="{selected_planner}"/>
            <Action ID="FollowPath" controller_id="{selected_controller}" error_code_id="{follow_path_error_code}" path="{path}"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="HomeGripperIfNeeded">
        <ReactiveFallback>
            <BlackboardCheckBool expected="false" key="shouldHomeGripper"/>
            <Action ID="HomeGripper"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="NavigatoToLocation">
        <ReactiveSequence name="ReturnToUser">
            <Action ID="ComputeGoalFromLocation" goal="{goal}" location="{location}"/>
            <Action ID="ComputePathToPose" error_code_id="{compute_path_error_code}" goal="{goal}" path="{path}" planner_id="{selected_planner}"/>
            <Action ID="FollowPath" controller_id="{selected_controller}" error_code_id="{follow_path_error_code}" path="{path}"/>
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="ReactiveRobotSafety">
        <ReactiveSequence>
            <SubTree ID="EnsureBatteryIsNoCritical"/>
            <SubTree ID="RobotIsNotEStopped"/>
            <SubTree ID="RobotHasNotFallenOver"/>
            <SubTree ID="RobotIsNotAboutToFallOver"/>
            <SubTree ID="BatteryIsCharged"/>
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotHasNotFallenOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedCritically"/>
            </Inverter>
            <Action ID="ShutdownSystem"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotAboutToFallOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedWarning"/>
            </Inverter>
            <Action ID="SoftwareEStop" reason="Robot is about to fall over"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotEStopped">
        <Inverter>
            <Condition ID="RobotIsEstopped"/>
        </Inverter>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RotateUntilWideAngleSeesObjectOfInterest">
        <ReactiveFallback name="SpinUntilObjectOfInterestSeen">
            <Condition ID="CanSeeObjectOfInterestWithWideAngleCamera" objectOfInterest="{objectOfInterest}"/>
            <ForceFailure>
                <Decorator ID="ReactiveRepeat" num_cycles="12">
                    <Action ID="RotateRobot" degrees="30"/>
                </Decorator>
            </ForceFailure>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SetupFetchAnObject">
        <Sequence>
            <SetBlackboard output_key="whereIAm" value="{currentLocation}"/>
            <SetBlackboard output_key="objectOfInterest" value="&quot;BeerCan&quot;"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="BatteryAboveChargingVoltage"/>
        <Condition ID="BatteryAboveCriticalVoltage"/>
        <SubTree ID="BatteryIsCharged"/>
        <Condition ID="CanSeeObjectOfInterestWithWideAngleCamera">
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </Condition>
        <Action ID="ChargeBattery"/>
        <Action ID="ComputeGoalFromLocation">
            <output_port name="goal">Computed goal pose</output_port>
            <input_port default="{location}" name="location">Location to compute goal for</input_port>
        </Action>
        <Action ID="ComputePathToPose">
            <output_port name="error_code_id">Start pose</output_port>
            <input_port name="goal">Goal pose</input_port>
            <output_port name="path">Path</output_port>
            <input_port name="planner_id">Planner to use</input_port>
        </Action>
        <Condition ID="ElevatorIsAtMaximumHeight"/>
        <Condition ID="ElevatorIsAtObjectHeight">
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </Condition>
        <SubTree ID="EnsureBatteryIsNoCritical"/>
        <Condition ID="ExtenderIsRetracted"/>
        <SubTree ID="FetchObjectOfInterest">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </SubTree>
        <SubTree ID="FindObjectOfInterest">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
            <input_port default="{travelWithGripperHomed}" name="shouldHomeGripper"/>
        </SubTree>
        <Action ID="FollowPath">
            <input_port name="controller_id">Controller to use</input_port>
            <output_port name="error_code_id">Error code</output_port>
            <input_port name="path">Path to follow</input_port>
        </Action>
        <SubTree ID="GoToGoal">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port name="goal">Goal pose to navigate to</input_port>
            <input_port name="selected_controller">Controller ID to use</input_port>
            <input_port name="selected_planner">Planner ID to use</input_port>
        </SubTree>
        <Condition ID="GripperIsHomed"/>
        <Action ID="HomeGripper"/>
        <SubTree ID="HomeGripperIfNeeded">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="true" name="shouldHomeGripper"/>
        </SubTree>
        <Condition ID="IsAtPose">
            <input_port default="HomeLocation" name="pose"/>
        </Condition>
        <Action ID="MoveElevatorRelative">
            <input_port default="0" name="distance_mm">+/- value to move from current position</input_port>
        </Action>
        <Action ID="NavigateToPose">
            <input_port default="Home" name="pose">Pose to move robot</input_port>
        </Action>
        <SubTree ID="NavigatoToLocation">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="{objectOfInterest}" name="location"/>
        </SubTree>
        <Condition ID="ObjectOfInterestIsCenteredInGripper">
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </Condition>
        <Condition ID="ObjectOfInterestIsGrasped">
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </Condition>
        <Decorator ID="ReactiveRepeat">
            <input_port name="num_cycles">Number of cycles to repeat</input_port>
        </Decorator>
        <SubTree ID="ReactiveRobotSafety"/>
        <Action ID="RecoverFromNavigateToPose"/>
        <Action ID="ReturnToLocation">
            <input_port default="{whereIAm}" name="location"/>
        </Action>
        <SubTree ID="RobotHasNotFallenOver"/>
        <Condition ID="RobotIsEstopped"/>
        <SubTree ID="RobotIsNotAboutToFallOver"/>
        <SubTree ID="RobotIsNotEStopped"/>
        <Condition ID="RobotTiltedCritically"/>
        <Condition ID="RobotTiltedWarning"/>
        <Action ID="RotateRobot">
            <input_port default="0" name="degrees">Degrees to rotate in +/- 0..360</input_port>
        </Action>
        <Action ID="RotateToCenterObjectOfInterestInGripper">
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </Action>
        <SubTree ID="RotateUntilWideAngleSeesObjectOfInterest">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="{objectOfInterest}" name="objectOfInterest"/>
        </SubTree>
        <Action ID="SetRobotLocation">
            <output_port name="currentLocation"/>
        </Action>
        <SubTree ID="SetupFetchAnObject">
            <input_port default="true" name="__shared_blackboard">If false (default), the Subtree has an isolated blackboard and needs port remapping</input_port>
            <input_port default="&quot;codeZeroCan&quot;" name="objectOfInterest"/>
        </SubTree>
        <Action ID="ShutdownSystem"/>
        <Action ID="SoftwareEStop">
            <input_port default="Help Me" name="reason">Reason to signal emergency stop</input_port>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
