<?xml version="1.0"?>
<root main_tree_to_execute="MainTree">
    <!-- ////////// -->
    <BehaviorTree ID="BatteryIsCharged">
        <ReactiveFallback name="ChargingNotNeeded">
            <Condition ID="BatteryAboveChargingVoltage"/>
            <Action ID="ChargeBattery"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="EnsureBatteryIsNoCritical">
        <ReactiveFallback name="SystemShutdownNotNeeded">
            <Condition ID="BatteryAboveCriticalVoltage"/>
            <Action ID="ShutdownSystem"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="MainTree">
        <Sequence>
            <SubTree ID="SetupWorld" __shared_blackboard="true" objectOfInterest="cokeZeroCan"/>
            <SubTree ID="ReactiveRobotSafety"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="ReactiveRobotSafety">
        <ReactiveSequence>
            <SubTree ID="RobotHasNotFallenOver"/>
            <SubTree ID="RobotIsNotAboutToFallOver"/>
            <SubTree ID="RobotIsNotEStopped"/>
            <SubTree ID="EnsureBatteryIsNoCritical"/>
            <SubTree ID="BatteryIsCharged"/>
        </ReactiveSequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotHasNotFallenOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedCritically"/>
            </Inverter>
            <Action ID="ShutdownSystem"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotAboutToFallOver">
        <ReactiveFallback>
            <Inverter>
                <Condition ID="RobotTiltedWarning"/>
            </Inverter>
            <Action ID="SoftwareEStop" reason="Robot is about to fall over"/>
        </ReactiveFallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="RobotIsNotEStopped">
        <Inverter>
            <Condition ID="RobotIsEstopped"/>
        </Inverter>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SetupWorld">
        <Sequence>
            <Action ID="SaveRobotPose" saveTo="{currentLocation}"/>
            <SetBlackboard output_key="objectOfInterest" value="CokeZeroCan"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="BatteryAboveChargingVoltage"/>
        <Condition ID="BatteryAboveCriticalVoltage"/>
        <SubTree ID="BatteryIsCharged"/>
        <Action ID="ChargeBattery"/>
        <SubTree ID="EnsureBatteryIsNoCritical"/>
        <SubTree ID="ReactiveRobotSafety"/>
        <SubTree ID="RobotHasNotFallenOver"/>
        <Condition ID="RobotIsEstopped"/>
        <SubTree ID="RobotIsNotAboutToFallOver"/>
        <SubTree ID="RobotIsNotEStopped"/>
        <Condition ID="RobotTiltedCritically"/>
        <Condition ID="RobotTiltedWarning"/>
        <Action ID="SaveRobotPose">
            <output_port name="saveTo">Where to save current pose</output_port>
        </Action>
        <SubTree ID="SetupWorld">
            <input_port default="true" name="__shared_blackboard"/>
            <input_port default="cokeZeroCan" name="objectOfInterest"/>
        </SubTree>
        <Action ID="ShutdownSystem"/>
        <Action ID="SoftwareEStop">
            <input_port default="Help Me" name="reason">Reason to signal emergency stop</input_port>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
