<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <RetryUntilSuccessful num_attempts="-1" name="KeepTrying">
            <ReactiveFallback name="ReactiveMainFallback">
                <!-- Priority 1: Handle low battery emergencies immediately -->
                <Sequence name="EmergencyBatterySequence">
                    <CheckBatteryState name="CheckEmergencyBattery" low_battery_threshold="20.0"/>
                    <NavigateToPose name="EmergencyGoToCharging" 
                                   target_pose="{charging_pose}" 
                                   timeout="60.0"
                                   goal_interrupted="{emergency_charging_interrupted}"/>
                    <AlwaysSuccess name="EmergencyChargingComplete"/> <!-- In practice, wait for sufficient charge -->
                </Sequence>
                
                <!-- Priority 2: Main waypoint following with reactive battery handling -->
                <Sequence name="ReactiveWaypointFollowing">
                    <!-- Check sensors are working -->
                    <CheckLidarHealth name="CheckLidar" 
                                     max_invalid_ratio="0.6" 
                                     scan_timeout="3.0"/>
                    
                    <!-- Load waypoints from database (only needs to happen once) -->
                    <LoadWaypoints name="LoadWaypointsFromDB" 
                                  database_path="{waypoint_database_path}"
                                  waypoints_loaded="{waypoints_available}"/>
                    
                    <!-- Check if we have completed all waypoints -->
                    <CheckWaypointsComplete name="CheckComplete" 
                                          current_waypoint_index="{current_waypoint_index}"
                                          total_waypoints="{total_waypoints}"
                                          loop_waypoints="{loop_waypoints}"
                                          all_complete="{waypoints_complete}"/>
                    
                    <!-- Get next waypoint to visit -->
                    <GetNextWaypoint name="GetNextWaypoint" 
                                    current_waypoint_index="{current_waypoint_index}"
                                    target_pose="{target_waypoint_pose}"
                                    waypoint_id="{current_waypoint_id}"
                                    waypoint_name="{current_waypoint_name}"/>
                    
                    <!-- Reactive navigation that can be interrupted for charging -->
                    <ReactiveFallback name="ReactiveNavigation">
                        <!-- Priority 1: Check if battery is getting low during navigation -->
                        <Sequence name="LowBatteryDuringNav">
                            <CheckBatteryState name="CheckBatteryDuringNav" low_battery_threshold="15.0"/>
                            <NavigateToPose name="GoToChargingDuringNav" 
                                           target_pose="{charging_pose}" 
                                           timeout="60.0"
                                           goal_interrupted="{charging_interrupted}"/>
                            <AlwaysSuccess name="ChargingComplete"/> <!-- In practice, wait for sufficient charge -->
                        </Sequence>
                        
                        <!-- Priority 2: Continue or resume waypoint navigation -->
                        <Fallback name="NavigationFallback">
                            <!-- Resume interrupted navigation if it was interrupted for charging -->
                            <Sequence name="ResumeInterruptedNavigation">
                                <CheckGoalInterrupted name="CheckIfInterrupted" was_interrupted="{waypoint_nav_interrupted}"/>
                                <NavigateToPose name="ResumeNavigateToPose" 
                                               target_pose="{target_waypoint_pose}"
                                               timeout="120.0"
                                               goal_interrupted="{waypoint_nav_interrupted}"/>
                            </Sequence>
                            
                            <!-- Start fresh navigation to waypoint -->
                            <NavigateToPose name="NavigateToWaypoint" 
                                           target_pose="{target_waypoint_pose}"
                                           timeout="120.0"
                                           goal_interrupted="{waypoint_nav_interrupted}"/>
                        </Fallback>
                    </ReactiveFallback>
                    
                    <!-- Mark waypoint as visited and move to next -->
                    <Sequence name="WaypointCompletedSequence">
                        <MarkWaypointVisited name="MarkVisited" 
                                           waypoint_id="{current_waypoint_id}"/>
                        <IncrementWaypointIndex name="IncrementIndex" 
                                              current_waypoint_index="{current_waypoint_index}"/>
                    </Sequence>
                </Sequence>
            </ReactiveFallback>
        </RetryUntilSuccessful>
    </BehaviorTree>
</root>
