<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <RetryUntilSuccessful num_attempts="-1" name="KeepTrying">
            <Fallback name="MainFallback">
                <!-- Priority 1: Handle critical battery emergencies -->
                <Sequence name="EmergencyBatterySequence">
                    <CheckBatteryState name="CheckEmergencyBattery" low_battery_threshold="32.0"/>
                    <NavigateToPose name="EmergencyGoToCharging" 
                                   target_pose="{charging_pose}" 
                                   timeout="60.0"
                                   goal_interrupted="{emergency_charging_interrupted}"/>
                    <AlwaysSuccess name="EmergencyChargingComplete"/>
                </Sequence>
                
                <!-- Priority 2: Main waypoint patrol (always runs if no emergency) -->
                <Sequence name="MainWaypointPatrol">
                    <!-- Load waypoints once at startup -->
                    <LoadWaypoints name="LoadWaypointsFromDB" 
                                  database_path="{waypoint_database_path}"
                                  waypoints_loaded="{waypoints_available}"/>
                    
                    <!-- Continuous waypoint following loop -->
                    <RetryUntilSuccessful num_attempts="-1" name="WaypointLoop">
                        <Sequence name="SingleWaypointCycle">
                            <!-- Check if all waypoints completed -->
                            <CheckWaypointsComplete name="CheckComplete" 
                                                  current_waypoint_index="{current_waypoint_index}"
                                                  total_waypoints="{total_waypoints}"
                                                  loop_waypoints="{loop_waypoints}"
                                                  all_complete="{waypoints_complete}"/>
                            
                            <!-- Get next waypoint -->
                            <GetNextWaypoint name="GetNextWaypoint" 
                                            current_waypoint_index="{current_waypoint_index}"
                                            target_pose="{target_waypoint_pose}"
                                            waypoint_id="{current_waypoint_id}"
                                            waypoint_name="{current_waypoint_name}"/>
                            
                            <!-- Optional sensor check -->
                            <Fallback name="SensorCheckFallback">
                                <CheckLidarHealth name="CheckLidar" 
                                                 max_invalid_ratio="0.6" 
                                                 scan_timeout="3.0"/>
                                <AlwaysSuccess name="ProceedWithoutLidarCheck"/>
                            </Fallback>
                            
                            <!-- Navigation with battery monitoring -->
                            <Fallback name="NavigationAttempt">
                                <!-- Try navigation with success tracking -->
                                <Sequence name="SuccessfulNavigation">
                                    <ReactiveFallback name="ReactiveNavigation">
                                        <!-- Check for low battery during navigation -->
                                        <Sequence name="LowBatteryDuringNav">
                                            <CheckBatteryState name="CheckBatteryDuringNav" low_battery_threshold="34.0"/>
                                            <NavigateToPose name="GoToChargingDuringNav" 
                                                           target_pose="{charging_pose}" 
                                                           timeout="60.0"
                                                           goal_interrupted="{charging_interrupted}"/>
                                            <AlwaysSuccess name="ChargingComplete"/>
                                        </Sequence>
                                        
                                        <!-- Normal waypoint navigation -->
                                        <NavigateToPose name="NavigateToWaypoint" 
                                                       target_pose="{target_waypoint_pose}"
                                                       timeout="120.0"
                                                       goal_interrupted="{waypoint_nav_interrupted}"/>
                                    </ReactiveFallback>
                                    
                                    <!-- Mark successful waypoint as visited -->
                                    <MarkWaypointVisited name="MarkVisited" 
                                                       waypoint_id="{current_waypoint_id}"/>
                                </Sequence>
                                
                                <!-- If navigation failed, continue anyway -->
                                <AlwaysSuccess name="SkipFailedWaypoint"/>
                            </Fallback>
                            
                            <!-- Always advance to next waypoint -->
                            <IncrementWaypointIndex name="IncrementIndex" 
                                                  current_waypoint_index="{current_waypoint_index}"/>
                        </Sequence>
                    </RetryUntilSuccessful>
                </Sequence>
            </Fallback>
        </RetryUntilSuccessful>
    </BehaviorTree>
</root>
