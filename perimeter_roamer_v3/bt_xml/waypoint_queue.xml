<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <RetryUntilSuccessful num_attempts="-1" name="KeepPatrolling">
            <Fallback name="MainFallback">
                <!-- Battery Check and Charging Sequence -->
                <Sequence name="BatteryCheckSequence">
                    <CheckBatteryState name="CheckBattery"/>
                    <NavigateToPose2D name="GoToCharging" 
                                     target_waypoint="{charging_waypoint}" 
                                     timeout="60.0"/>
                </Sequence>
                
                <!-- Queue-based Waypoint Following -->
                <Sequence name="WaypointQueueSequence">
                    <!-- Generate waypoints once at the beginning -->
                    <GenerateWaypoints name="LoadWaypoints" 
                                      database_path="{waypoint_database_path}"
                                      waypoint_queue="{waypoint_queue}"/>
                    
                    <!-- Loop through all waypoints in queue -->
                    <LoopNode queue="{waypoint_queue}" name="WaypointLoop">
                        <Sequence name="ProcessWaypoint">
                            <!-- Get next waypoint from queue (automatically advances) -->
                            <UseWaypoint name="GetNextWaypoint" 
                                        waypoint_queue="{waypoint_queue}"
                                        current_waypoint="{current_waypoint}"/>
                            
                            <!-- Try to navigate to waypoint (failure doesn't stop the loop) -->
                            <NavigateToPose2D name="NavigateToWaypoint" 
                                            target_waypoint="{current_waypoint}"
                                            timeout="30.0"/>
                        </Sequence>
                    </LoopNode>
                </Sequence>
            </Fallback>
        </RetryUntilSuccessful>
    </BehaviorTree>
</root>
